<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¯ä»˜é“¾æ¥ç”Ÿæˆå™¨</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        input,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .generate-btn {
            width: 100%;
            padding: 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }

        .generate-btn:hover {
            background: #0056b3;
        }

        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
            word-break: break-all;
        }

        .url-display {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            word-break: break-all;
        }

        .test-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }

        .test-btn:hover {
            background: #218838;
        }

        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ”— Whop æ”¯ä»˜é“¾æ¥ç”Ÿæˆå™¨</h1>

        <div class="info">
            <strong>ğŸ“‹ è¯´æ˜:</strong><br>
            è¿™ä¸ªå·¥å…·å¯ä»¥å¸®ä½ ç”Ÿæˆ Whop æ”¯ä»˜é“¾æ¥ï¼Œç”¨äºæµ‹è¯•æ”¯ä»˜æµç¨‹ã€‚
        </div>

        <form id="paymentForm">
            <div class="form-group">
                <label for="userId">ç”¨æˆ· ID:</label>
                <input type="text" id="userId" value="6948dc4897532de886ec876d" required>
            </div>

            <div class="form-group">
                <label for="userEmail">ç”¨æˆ·é‚®ç®±:</label>
                <input type="email" id="userEmail" value="nfkmr920@gmail.com" required>
            </div>

            <div class="form-group">
                <label for="packageId">ç§¯åˆ†å¥—é¤:</label>
                <select id="packageId" required>
                    <option value="credits_100">100 ç§¯åˆ† - $1.00</option>
                    <option value="credits_1000" selected>1000 ç§¯åˆ† - $10.00</option>
                    <option value="credits_15000">15000 ç§¯åˆ† - $100.00</option>
                </select>
            </div>

            <div class="form-group">
                <label for="credits">ç§¯åˆ†æ•°é‡:</label>
                <input type="number" id="credits" value="1000" required>
            </div>

            <button type="button" class="generate-btn" onclick="generatePaymentUrl()">
                ç”Ÿæˆæ”¯ä»˜é“¾æ¥
            </button>
        </form>

        <div id="result" style="display: none;" class="result">
            <h3>ç”Ÿæˆçš„æ”¯ä»˜é“¾æ¥:</h3>
            <div id="urlDisplay" class="url-display"></div>

            <div style="margin-top: 15px;">
                <button class="test-btn" onclick="openPaymentUrl()">åœ¨æ–°çª—å£æ‰“å¼€</button>
                <button class="test-btn" onclick="copyToClipboard()">å¤åˆ¶é“¾æ¥</button>
                <button class="test-btn" onclick="testCurrentUser()">ä½¿ç”¨å½“å‰ç”¨æˆ·ä¿¡æ¯</button>
            </div>

            <div id="urlBreakdown" style="margin-top: 20px;"></div>
        </div>

        <div class="info">
            <strong>ğŸ”§ API æ¥å£ä¿¡æ¯:</strong><br>
            <strong>å†…åµŒæ”¯ä»˜ API:</strong>
            <code>POST https://inkgeniusapi.digworldai.com/api/payment/create-embedded</code><br>
            <strong>è¯·æ±‚ä½“:</strong> <code>{"packageId": "credits_1000"}</code><br>
            <strong>éœ€è¦ Authorization å¤´:</strong> <code>Bearer &lt;token&gt;</code><br><br>

            <strong>Webhook URL:</strong> <code>https://inkgeniusapi.digworldai.com/api/payment/webhook/whop</code><br>
            <strong>æ”¯æŒäº‹ä»¶:</strong> <code>payment.succeeded</code>, <code>payment.completed</code>
        </div>
    </div>

    <script>
        let generatedUrl = '';

        const packageInfo = {
            'credits_100': { credits: 100, name: '100 ç§¯åˆ†', price: 1.00 },
            'credits_1000': { credits: 1000, name: '1000 ç§¯åˆ†', price: 10.00 },
            'credits_15000': { credits: 15000, name: '15000 ç§¯åˆ†', price: 100.00 }
        };

        // è‡ªåŠ¨æ›´æ–°ç§¯åˆ†æ•°é‡
        document.getElementById('packageId').addEventListener('change', function () {
            const selectedPackage = this.value;
            const credits = packageInfo[selectedPackage].credits;
            document.getElementById('credits').value = credits;
        });

        function generatePaymentUrl() {
            const userId = document.getElementById('userId').value;
            const userEmail = document.getElementById('userEmail').value;
            const packageId = document.getElementById('packageId').value;
            const credits = document.getElementById('credits').value;

            if (!userId || !userEmail || !packageId || !credits) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…éœ€å­—æ®µ');
                return;
            }

            // æ„å»º Whop æ”¯ä»˜é“¾æ¥
            const baseUrl = 'https://whop.com/checkout/plan_AvXNl6DA1jtOj/';
            const params = new URLSearchParams({
                'metadata[user_id]': userId,
                'metadata[user_email]': userEmail,
                'metadata[package_id]': packageId,
                'metadata[credits]': credits,
            });

            generatedUrl = `${baseUrl}?${params.toString()}`;

            // æ˜¾ç¤ºç»“æœ
            document.getElementById('urlDisplay').textContent = generatedUrl;
            document.getElementById('result').style.display = 'block';

            // æ˜¾ç¤ºé“¾æ¥åˆ†è§£
            const breakdown = `
                <h4>é“¾æ¥åˆ†è§£:</h4>
                <p><strong>åŸºç¡€ URL:</strong> ${baseUrl}</p>
                <p><strong>å‚æ•°:</strong></p>
                <ul>
                    <li>metadata[user_id]: ${userId}</li>
                    <li>metadata[user_email]: ${userEmail}</li>
                    <li>metadata[package_id]: ${packageId}</li>
                    <li>metadata[credits]: ${credits}</li>
                </ul>
                <p><strong>å¥—é¤ä¿¡æ¯:</strong> ${packageInfo[packageId].name} - $${packageInfo[packageId].price}</p>
            `;
            document.getElementById('urlBreakdown').innerHTML = breakdown;

            console.log('ğŸ”— Generated payment URL:', generatedUrl);
            console.log('ğŸ“‹ Parameters:', { userId, userEmail, packageId, credits });
        }

        function openPaymentUrl() {
            if (generatedUrl) {
                window.open(generatedUrl, '_blank');
            } else {
                alert('è¯·å…ˆç”Ÿæˆæ”¯ä»˜é“¾æ¥');
            }
        }

        function copyToClipboard() {
            if (generatedUrl) {
                navigator.clipboard.writeText(generatedUrl).then(() => {
                    alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }).catch(() => {
                    // å¤‡ç”¨æ–¹æ³•
                    const textArea = document.createElement('textarea');
                    textArea.value = generatedUrl;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                });
            } else {
                alert('è¯·å…ˆç”Ÿæˆæ”¯ä»˜é“¾æ¥');
            }
        }

        function testCurrentUser() {
            // å°è¯•ä» localStorage è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
            const userStr = localStorage.getItem('user');
            if (userStr) {
                try {
                    const user = JSON.parse(userStr);
                    console.log('ğŸ‘¤ Current user from localStorage:', user);

                    // æ›´æ–°è¡¨å•å­—æ®µ
                    if (user.id) document.getElementById('userId').value = user.id;
                    if (user.email) document.getElementById('userEmail').value = user.email;

                    alert('å·²ä½¿ç”¨å½“å‰ç”¨æˆ·ä¿¡æ¯æ›´æ–°è¡¨å•');
                } catch (e) {
                    alert('æ— æ³•è§£æç”¨æˆ·ä¿¡æ¯: ' + e.message);
                }
            } else {
                alert('æœªæ‰¾åˆ°å½“å‰ç”¨æˆ·ä¿¡æ¯');
            }
        }

        // é¡µé¢åŠ è½½æ—¶å°è¯•ä½¿ç”¨å½“å‰ç”¨æˆ·ä¿¡æ¯
        window.addEventListener('load', function () {
            const userStr = localStorage.getItem('user');
            if (userStr) {
                try {
                    const user = JSON.parse(userStr);
                    if (user.id) document.getElementById('userId').value = user.id;
                    if (user.email) document.getElementById('userEmail').value = user.email;
                } catch (e) {
                    console.log('Failed to load user info:', e);
                }
            }
        });
    </script>
</body>

</html>