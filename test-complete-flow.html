<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œæ•´æ”¯ä»˜æµç¨‹æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .info {
            background: #e3f2fd;
            color: #0c5460;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .step {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 15px 0;
        }

        .test-button {
            display: block;
            width: 100%;
            margin: 15px 0;
            padding: 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            text-decoration: none;
            text-align: center;
        }

        .test-button:hover {
            background: #1e7e34;
        }

        .test-button.secondary {
            background: #007bff;
        }

        .test-button.secondary:hover {
            background: #0056b3;
        }

        .url-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
        }

        .checklist {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .checklist ul {
            margin: 0;
            padding-left: 20px;
        }

        .checklist li {
            margin: 5px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ¯ å®Œæ•´æ”¯ä»˜æµç¨‹æµ‹è¯•</h1>

        <div class="success">
            <h3>âœ… ç³»ç»Ÿå·²ä¼˜åŒ–</h3>
            <ul>
                <li>âœ… URLæ ¼å¼ä¿®å¤: ä½¿ç”¨ <code>/checkout/</code> è·¯å¾„</li>
                <li>âœ… å¥—é¤ç®€åŒ–: åªä¿ç•™1000ç§¯åˆ†å¥—é¤</li>
                <li>âœ… Webhookä¼˜åŒ–: ç®€åŒ–å¤„ç†é€»è¾‘ï¼Œå›ºå®šæ·»åŠ 1000ç§¯åˆ†</li>
                <li>âœ… å…œåº•æœºåˆ¶: å¤šç§ç”¨æˆ·ä¿¡æ¯è·å–æ–¹å¼</li>
            </ul>
        </div>

        <div class="step">
            <h3>ğŸ“‹ å½“å‰é…ç½®</h3>
            <div id="config-info"></div>
        </div>

        <div class="step">
            <h3>ğŸš€ å¼€å§‹æµ‹è¯•</h3>
            <p>ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®å¼€å§‹å®Œæ•´çš„æ”¯ä»˜æµç¨‹æµ‹è¯•ï¼š</p>

            <button class="test-button" onclick="startPaymentTest()">
                ğŸ’³ å¼€å§‹æ”¯ä»˜æµ‹è¯•
            </button>

            <button class="test-button secondary" onclick="checkCredits()">
                ğŸ’° æ£€æŸ¥å½“å‰ç§¯åˆ†
            </button>
        </div>

        <div class="checklist">
            <h3>ğŸ“ æµ‹è¯•æ£€æŸ¥æ¸…å•</h3>
            <ul>
                <li>â–¡ æ”¯ä»˜é“¾æ¥æ­£å¸¸æ‰“å¼€</li>
                <li>â–¡ æ˜¾ç¤ºæ­£ç¡®çš„äº§å“ä¿¡æ¯ (1000ç§¯åˆ†, $10.00)</li>
                <li>â–¡ å®Œæˆæ”¯ä»˜æµç¨‹</li>
                <li>â–¡ æœåŠ¡å™¨æ”¶åˆ°webhookäº‹ä»¶</li>
                <li>â–¡ ç”¨æˆ·ç§¯åˆ†å¢åŠ 1000</li>
                <li>â–¡ æ”¯ä»˜è®°å½•ä¿å­˜åˆ°æ•°æ®åº“</li>
            </ul>
        </div>

        <div class="step">
            <h3>ğŸ” è°ƒè¯•ä¿¡æ¯</h3>
            <div id="debug-info"></div>
        </div>

        <div class="info">
            <h3>ğŸ“Š Webhookå¤„ç†é€»è¾‘</h3>
            <p>ç®€åŒ–åçš„webhookå¤„ç†æµç¨‹ï¼š</p>
            <ol>
                <li><strong>æ¥æ”¶äº‹ä»¶</strong>: ç›‘å¬ <code>payment.succeeded</code> äº‹ä»¶</li>
                <li><strong>è·å–ç”¨æˆ·ä¿¡æ¯</strong>: å°è¯•ä»å¤šä¸ªæ¥æºè·å–ç”¨æˆ·IDå’Œé‚®ç®±</li>
                <li><strong>å…œåº•æœºåˆ¶</strong>: å¦‚æœæ— æ³•è·å–ï¼Œä½¿ç”¨é»˜è®¤æµ‹è¯•ç”¨æˆ·</li>
                <li><strong>å›ºå®šç§¯åˆ†</strong>: æ— è®ºä»€ä¹ˆæƒ…å†µï¼Œéƒ½æ·»åŠ 1000ç§¯åˆ†</li>
                <li><strong>è®°å½•æ”¯ä»˜</strong>: ä¿å­˜æ”¯ä»˜è®°å½•åˆ°æ•°æ®åº“</li>
                <li><strong>æ›´æ–°ç§¯åˆ†</strong>: æ›´æ–°ç”¨æˆ·çš„ç§¯åˆ†ä½™é¢</li>
            </ol>
        </div>

        <div class="step">
            <h3>ğŸ”— ç›¸å…³é“¾æ¥</h3>
            <ul>
                <li><a href="https://whop.com/dashboard" target="_blank">Whop å•†å®¶åå°</a></li>
                <li><a href="https://inkgeniusapi.digworldai.com/api/payment/webhook/whop" target="_blank">Webhook
                        ç«¯ç‚¹</a></li>
                <li><a href="test-fixed-payment.html" target="_blank">ç®€å•æ”¯ä»˜æµ‹è¯•</a></li>
            </ul>
        </div>

        <div class="step">
            <h3>ğŸ“ˆ æµ‹è¯•ç»“æœ</h3>
            <div id="test-results"></div>
        </div>
    </div>

    <script>
        // è·å–ç”¨æˆ·ä¿¡æ¯
        function getUserInfo() {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                return {
                    userId: '6948dc4897532de886ec876d',
                    userEmail: 'test@example.com',
                    isLoggedIn: false
                };
            }

            try {
                const user = JSON.parse(userStr);
                return {
                    userId: user.id || user.user_id || user.sub || '6948dc4897532de886ec876d',
                    userEmail: user.email || user.user_email || 'test@example.com',
                    credits: user.user_metadata?.credits || 0,
                    isLoggedIn: true
                };
            } catch (e) {
                return {
                    userId: '6948dc4897532de886ec876d',
                    userEmail: 'test@example.com',
                    isLoggedIn: false
                };
            }
        }

        // ç”Ÿæˆæ”¯ä»˜é“¾æ¥
        function generatePaymentUrl() {
            const { userId, userEmail } = getUserInfo();
            const baseUrl = 'https://whop.com/checkout/plan_AvXNl6DA1jtOj/';

            const params = new URLSearchParams({
                'metadata[user_id]': userId,
                'metadata[user_email]': userEmail,
                'metadata[package_id]': 'credits_1000',
                'metadata[credits]': '1000',
            });

            return `${baseUrl}?${params.toString()}`;
        }

        // å¼€å§‹æ”¯ä»˜æµ‹è¯•
        function startPaymentTest() {
            const url = generatePaymentUrl();
            console.log('ğŸš€ å¼€å§‹æ”¯ä»˜æµ‹è¯•:', url);

            // è®°å½•æµ‹è¯•å¼€å§‹
            logTestResult('æ”¯ä»˜æµ‹è¯•å¼€å§‹', `æ‰“å¼€æ”¯ä»˜é“¾æ¥: ${url}`);

            const newWindow = window.open(url, 'whop-complete-test', 'width=800,height=600,scrollbars=yes,resizable=yes');

            if (!newWindow) {
                alert('å¼¹çª—è¢«é˜»æ­¢ï¼Œè¯·å…è®¸å¼¹çª—æˆ–æ‰‹åŠ¨å¤åˆ¶é“¾æ¥æ‰“å¼€:\n\n' + url);
                logTestResult('å¼¹çª—è¢«é˜»æ­¢', 'è¯·æ‰‹åŠ¨æ‰“å¼€é“¾æ¥');
            } else {
                logTestResult('æ”¯ä»˜çª—å£å·²æ‰“å¼€', 'è¯·å®Œæˆæ”¯ä»˜æµç¨‹');

                // å®šæœŸæ£€æŸ¥çª—å£çŠ¶æ€
                const checkInterval = setInterval(() => {
                    if (newWindow.closed) {
                        clearInterval(checkInterval);
                        logTestResult('æ”¯ä»˜çª—å£å·²å…³é—­', 'è¯·æ£€æŸ¥ç§¯åˆ†æ˜¯å¦å¢åŠ ');

                        // å»¶è¿Ÿæ£€æŸ¥ç§¯åˆ†
                        setTimeout(() => {
                            checkCredits();
                        }, 2000);
                    }
                }, 1000);
            }
        }

        // æ£€æŸ¥ç§¯åˆ†
        function checkCredits() {
            const userInfo = getUserInfo();
            console.log('ğŸ’° æ£€æŸ¥ç§¯åˆ†:', userInfo);

            logTestResult('ç§¯åˆ†æ£€æŸ¥', `å½“å‰ç§¯åˆ†: ${userInfo.credits || 0}`);

            if (userInfo.isLoggedIn) {
                // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œå¯ä»¥å°è¯•åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
                logTestResult('ç”¨æˆ·çŠ¶æ€', 'å·²ç™»å½•ï¼Œç§¯åˆ†ä¿¡æ¯å¯èƒ½éœ€è¦åˆ·æ–°é¡µé¢æŸ¥çœ‹');
            } else {
                logTestResult('ç”¨æˆ·çŠ¶æ€', 'æœªç™»å½•ï¼Œä½¿ç”¨é»˜è®¤æµ‹è¯•ç”¨æˆ·');
            }
        }

        // è®°å½•æµ‹è¯•ç»“æœ
        function logTestResult(action, details) {
            const resultDiv = document.getElementById('test-results');
            const timestamp = new Date().toLocaleTimeString();

            resultDiv.innerHTML += `
                <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 4px;">
                    <strong>[${timestamp}] ${action}</strong><br>
                    <span style="color: #666; font-size: 14px;">${details}</span>
                </div>
            `;

            // æ»šåŠ¨åˆ°åº•éƒ¨
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function () {
            const userInfo = getUserInfo();
            const paymentUrl = generatePaymentUrl();

            // æ˜¾ç¤ºé…ç½®ä¿¡æ¯
            document.getElementById('config-info').innerHTML = `
                <div><strong>äº§å“ID:</strong> plan_AvXNl6DA1jtOj</div>
                <div><strong>URLæ ¼å¼:</strong> https://whop.com/checkout/plan_AvXNl6DA1jtOj/</div>
                <div><strong>å¥—é¤:</strong> 1000ç§¯åˆ† ($10.00 USD)</div>
                <div><strong>Webhook:</strong> https://inkgeniusapi.digworldai.com/api/payment/webhook/whop</div>
                <div class="url-display">
                    <strong>å®Œæ•´æ”¯ä»˜é“¾æ¥:</strong><br>
                    ${paymentUrl}
                </div>
            `;

            // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
            document.getElementById('debug-info').innerHTML = `
                <div><strong>ç”¨æˆ·ID:</strong> ${userInfo.userId}</div>
                <div><strong>é‚®ç®±:</strong> ${userInfo.userEmail}</div>
                <div><strong>å½“å‰ç§¯åˆ†:</strong> ${userInfo.credits || 0}</div>
                <div><strong>ç™»å½•çŠ¶æ€:</strong> ${userInfo.isLoggedIn ? 'å·²ç™»å½•' : 'æœªç™»å½•ï¼ˆä½¿ç”¨é»˜è®¤å€¼ï¼‰'}</div>
            `;

            console.log('âœ… å®Œæ•´æ”¯ä»˜æµç¨‹æµ‹è¯•é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            console.log('ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯:', userInfo);
            console.log('ğŸ”— æ”¯ä»˜é“¾æ¥:', paymentUrl);

            logTestResult('é¡µé¢åˆå§‹åŒ–', 'æµ‹è¯•ç¯å¢ƒå‡†å¤‡å®Œæˆ');
        });
    </script>
</body>

</html>