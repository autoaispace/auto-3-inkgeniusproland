<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whop å…ƒæ•°æ®è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .section h3 {
            margin: 0 0 15px 0;
            color: #333;
        }
        .info-item {
            margin: 8px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .test-button {
            display: inline-block;
            margin: 5px 10px 5px 0;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button.method2 { background: #28a745; }
        .test-button.method2:hover { background: #1e7e34; }
        .test-button.method3 { background: #ffc107; color: black; }
        .test-button.method3:hover { background: #e0a800; }
        .url-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Whop å…ƒæ•°æ®è°ƒè¯•å·¥å…·</h1>
        <p>è¿™ä¸ªå·¥å…·å¸®åŠ©è°ƒè¯• Whop æ”¯ä»˜ä¸­å…ƒæ•°æ®ä¼ é€’çš„é—®é¢˜</p>

        <div class="section">
            <h3>1. ç”¨æˆ·ä¿¡æ¯æ£€æŸ¥</h3>
            <div id="user-info"></div>
        </div>

        <div class="section">
            <h3>2. æ”¯ä»˜é“¾æ¥ç”Ÿæˆ</h3>
            <div id="payment-urls"></div>
        </div>

        <div class="section">
            <h3>3. æµ‹è¯•æ”¯ä»˜é“¾æ¥</h3>
            <p>ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®æµ‹è¯•ä¸åŒçš„å…ƒæ•°æ®ä¼ é€’æ–¹æ³•ï¼š</p>
            <div id="test-buttons"></div>
        </div>

        <div class="section">
            <h3>4. Whop é…ç½®å»ºè®®</h3>
            <div class="status warning">
                <strong>å¦‚æœå…ƒæ•°æ®ä»ç„¶ä¸ºç©ºï¼Œå¯èƒ½éœ€è¦åœ¨ Whop åå°é…ç½®ï¼š</strong>
                <ul>
                    <li>ç™»å½• Whop å•†å®¶åå°</li>
                    <li>æ‰¾åˆ°äº§å“è®¾ç½®</li>
                    <li>å¯ç”¨ "Custom Metadata" æˆ– "Webhook Metadata"</li>
                    <li>ç¡®ä¿ webhook ç«¯ç‚¹é…ç½®æ­£ç¡®</li>
                    <li>æ£€æŸ¥äº§å“æ˜¯å¦æ”¯æŒå…ƒæ•°æ®ä¼ é€’</li>
                    <li>å°è¯•ä½¿ç”¨ Whop çš„å†…åµŒæ”¯ä»˜ API è€Œä¸æ˜¯ç›´æ¥é“¾æ¥</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h3>5. Webhook æµ‹è¯•</h3>
            <p>æ”¯ä»˜å®Œæˆåï¼Œæ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—ä¸­çš„ webhook æ•°æ®ï¼š</p>
            <div class="url-display">
                Webhook URL: https://inkgeniusapi.digworldai.com/api/payment/webhook/whop
            </div>
            <p>æŸ¥æ‰¾æ—¥å¿—ä¸­çš„ "å…ƒæ•°æ®" å­—æ®µï¼Œç¡®è®¤æ˜¯å¦åŒ…å«ç”¨æˆ·ä¿¡æ¯ã€‚</p>
        </div>
    </div>

    <script>
        console.log('ğŸ” è°ƒè¯• Whop å…ƒæ•°æ®ä¼ é€’é—®é¢˜');

        // 1. æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯
        function checkUserInfo() {
            const userInfoDiv = document.getElementById('user-info');
            const userStr = localStorage.getItem('user');
            
            if (!userStr) {
                userInfoDiv.innerHTML = '<div class="status error">âŒ localStorage ä¸­æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯</div>';
                return null;
            }

            try {
                const user = JSON.parse(userStr);
                const userEmail = user.email || user.user_email;
                const userId = user.id || user.user_id || user.sub;
                
                userInfoDiv.innerHTML = `
                    <div class="status success">âœ… ç”¨æˆ·ä¿¡æ¯æ‰¾åˆ°</div>
                    <div class="info-item"><strong>ç”¨æˆ·ID:</strong> ${userId || 'æœªæ‰¾åˆ°'}</div>
                    <div class="info-item"><strong>é‚®ç®±:</strong> ${userEmail || 'æœªæ‰¾åˆ°'}</div>
                    <div class="info-item"><strong>å®Œæ•´ç”¨æˆ·å¯¹è±¡:</strong></div>
                    <div class="url-display">${JSON.stringify(user, null, 2)}</div>
                `;
                
                return { userId, userEmail };
            } catch (e) {
                userInfoDiv.innerHTML = `<div class="status error">âŒ è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${e.message}</div>`;
                return null;
            }
        }

        // 2. ç”Ÿæˆæ”¯ä»˜é“¾æ¥
        function generatePaymentUrls(userInfo) {
            const urlsDiv = document.getElementById('payment-urls');
            
            if (!userInfo) {
                urlsDiv.innerHTML = '<div class="status error">âŒ æ— æ³•ç”Ÿæˆæ”¯ä»˜é“¾æ¥ï¼šç¼ºå°‘ç”¨æˆ·ä¿¡æ¯</div>';
                return {};
            }

            const { userId, userEmail } = userInfo;
            const baseUrl = 'https://whop.com/checkout/plan_AvXNl6DA1jtOj/';
            
            // æ–¹æ³•1: URLSearchParams (å½“å‰æ–¹æ³•)
            const params1 = new URLSearchParams({
                'metadata[user_id]': userId || '6948dc4897532de886ec876d',
                'metadata[user_email]': userEmail || 'test@example.com',
                'metadata[package_id]': 'credits_1000',
                'metadata[credits]': '1000',
            });
            const url1 = `${baseUrl}?${params1.toString()}`;
            
            // æ–¹æ³•2: æ‰‹åŠ¨æ„å»º
            const metadataParams = [
                `metadata[user_id]=${encodeURIComponent(userId || '6948dc4897532de886ec876d')}`,
                `metadata[user_email]=${encodeURIComponent(userEmail || 'test@example.com')}`,
                `metadata[package_id]=${encodeURIComponent('credits_1000')}`,
                `metadata[credits]=${encodeURIComponent('1000')}`
            ].join('&');
            const url2 = `${baseUrl}?${metadataParams}`;
            
            // æ–¹æ³•3: ç®€å•å‚æ•°å
            const params3 = new URLSearchParams({
                'user_id': userId || '6948dc4897532de886ec876d',
                'user_email': userEmail || 'test@example.com',
                'package_id': 'credits_1000',
                'credits': '1000',
            });
            const url3 = `${baseUrl}?${params3.toString()}`;

            urlsDiv.innerHTML = `
                <div class="status success">âœ… æ”¯ä»˜é“¾æ¥å·²ç”Ÿæˆ</div>
                
                <h4>æ–¹æ³•1: URLSearchParams (å½“å‰ä½¿ç”¨)</h4>
                <div class="url-display">${url1}</div>
                
                <h4>æ–¹æ³•2: æ‰‹åŠ¨æ„å»ºå‚æ•°</h4>
                <div class="url-display">${url2}</div>
                
                <h4>æ–¹æ³•3: ç®€å•å‚æ•°å (æµ‹è¯•)</h4>
                <div class="url-display">${url3}</div>
            `;

            return { url1, url2, url3 };
        }

        // 3. åˆ›å»ºæµ‹è¯•æŒ‰é’®
        function createTestButtons(urls) {
            const buttonsDiv = document.getElementById('test-buttons');
            
            if (!urls.url1) {
                buttonsDiv.innerHTML = '<div class="status error">âŒ æ— æ³•åˆ›å»ºæµ‹è¯•æŒ‰é’®ï¼šç¼ºå°‘æ”¯ä»˜é“¾æ¥</div>';
                return;
            }

            buttonsDiv.innerHTML = `
                <button class="test-button" onclick="testPayment('${urls.url1}', 'æ–¹æ³•1')">
                    æµ‹è¯•æ–¹æ³•1 (URLSearchParams)
                </button>
                <button class="test-button method2" onclick="testPayment('${urls.url2}', 'æ–¹æ³•2')">
                    æµ‹è¯•æ–¹æ³•2 (æ‰‹åŠ¨æ„å»º)
                </button>
                <button class="test-button method3" onclick="testPayment('${urls.url3}', 'æ–¹æ³•3')">
                    æµ‹è¯•æ–¹æ³•3 (ç®€å•å‚æ•°)
                </button>
                <div style="margin-top: 15px;">
                    <div class="status warning">
                        <strong>æµ‹è¯•è¯´æ˜:</strong>
                        <ul>
                            <li>ç‚¹å‡»æŒ‰é’®ä¼šåœ¨æ–°çª—å£ä¸­æ‰“å¼€ Whop æ”¯ä»˜é¡µé¢</li>
                            <li>å®Œæˆæ”¯ä»˜åï¼Œæ£€æŸ¥æœåŠ¡å™¨ webhook æ—¥å¿—</li>
                            <li>æŸ¥çœ‹ webhook ä¸­çš„ "å…ƒæ•°æ®" å­—æ®µæ˜¯å¦åŒ…å«ç”¨æˆ·ä¿¡æ¯</li>
                            <li>å¦‚æœå…ƒæ•°æ®ä»ä¸ºç©ºï¼Œå¯èƒ½éœ€è¦è”ç³» Whop æ”¯æŒæˆ–ä½¿ç”¨å†…åµŒæ”¯ä»˜ API</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // æµ‹è¯•æ”¯ä»˜
        function testPayment(url, method) {
            console.log(`ğŸš€ æµ‹è¯•${method}:`, url);
            const newWindow = window.open(url, `whop-test-${method}`, 'width=800,height=600,scrollbars=yes,resizable=yes');
            
            if (!newWindow) {
                alert('å¼¹çª—è¢«é˜»æ­¢ï¼Œè¯·å…è®¸å¼¹çª—æˆ–æ‰‹åŠ¨å¤åˆ¶é“¾æ¥æ‰“å¼€');
            } else {
                console.log(`âœ… ${method} æ”¯ä»˜çª—å£å·²æ‰“å¼€`);
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”„ åˆå§‹åŒ–è°ƒè¯•å·¥å…·');
            
            const userInfo = checkUserInfo();
            const urls = generatePaymentUrls(userInfo);
            createTestButtons(urls);
            
            console.log('âœ… è°ƒè¯•å·¥å…·åˆå§‹åŒ–å®Œæˆ');
        });

        // å…¨å±€å‡½æ•°
        window.testPayment = testPayment;
    </script>
</body>
</html>